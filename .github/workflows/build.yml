name: build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  COMMON_MSBUILD_ARGS: /p:OutputPath=output /p:Platform=x64 /p:Configuration=Debug /p:WindowsTargetPlatformVersion=10.0 /p:WindowsTargetPlatformMinVersion=10.0.18362.0

jobs:
  winrt-build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: 'recursive'
    - name: setup-msbuild
      uses: microsoft/setup-msbuild@v1.0.2
    - name: Setup NuGet.exe for use with actions
      uses: NuGet/setup-nuget@v1
      with:
        nuget-version: latest  
    - name: Get the version
      id: get_version
      run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
      shell: bash
    - name: Patch version on git tag
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')
      run: |
        If ($env:GIT_TAG){
        (Get-Content .\project\Package.appxmanifest) | Foreach-Object {$_ -replace "1.0.0.0", "$env:GIT_TAG"} | Set-Content .\project\Package.appxmanifest
        Write-Host -ForegroundColor Yellow "Setting AppxManifest version to $env:GIT_TAG"
        }
        else
        {
        Write-Host -ForegroundColor Yellow "Not modifying version in AppxManifest"
        }
      shell: powershell
      env:
        GIT_TAG: ${{ steps.get_version.outputs.VERSION }}
    - name: NuGet restore
      run: |
        cd project
        nuget restore
        cd ..
    - name: overwrite vcxproj
      run: |
        echo overwrite vcxproj
        copy mixerfixfiles\* project\externals\SDL2_mixer\VisualC-WinRT\UWP_VS2015
    - name: Build project
      run: |
        cd project
        echo "$env:COMMON_MSBUILD_ARGS"
        echo "$env:PACKAGE_DIR"
        echo "$env:CERT_FILE"
        echo "$env:CERT_KEY"
        msbuild VVVVV.sln $env:COMMON_MSBUILD_ARGS /p:AppxBundlePlatforms="x64" /p:AppxPackageDir="$env:PACKAGE_DIR" /p:AppxBundle=Always /p:UapAppxPackageBuildMode="Sideload" /p:AppxPackageSigningEnabled=true /p:PackageCertificateThumbprint="" /p:PackageCertificateKeyFile="$env:CERT_FILE" /p:PackageCertificatePassword="$env:CERT_KEY"
        cd ..
      shell: powershell
      env:
        PACKAGE_DIR: appx
        PACKAGE_BUILD_MODE: SideloadOnly
        CERT_FILE: VVVVV_TemporaryKey.pfx
        CERT_KEY: ${{ secrets.CERT_KEY }}
